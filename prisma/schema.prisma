generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  output          = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Attendance {
  year     Int
  semester Int    @db.SmallInt
  week     Int    @db.SmallInt
  user_id  String

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([user_id, year, semester, week])
  @@index([year(sort: Desc), semester(sort: Desc), week(sort: Desc)])
}

model Equipment {
  id                String   @id @default(uuid())
  name              String
  inventory         Int      @default(1)
  condition         String   @default("OK")
  acquisition_date  DateTime
  acquisition_price Float?
  description       String?
  created_at        DateTime @default(now())
  updated_at        DateTime @default(now()) @updatedAt
}

model Instrument {
  name        String  @unique
  slug        String  @unique
  description String?

  Profiles      Profile[]
  PracticeParts PracticePart[]

  @@index([name(sort: Asc)])
}

model Library {
  id                String    @id @default(uuid())
  title             String
  acquisition_date  DateTime
  acquisition_price Float?
  composer          String?
  arranger          String?
  notes             String?
  lease_expiry      DateTime?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @default(now()) @updatedAt

  PracticeParts PracticePart[]
}

model MailingListRecipient {
  user_id    String   @id
  email      String   @unique
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  user User? @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model Payment {
  user_id    String
  amount     Float
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([user_id, created_at])
}

model PracticePart {
  id              String   @id @default(uuid())
  instrument_name String
  library_id      String
  variant         String?
  url             String
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now()) @updatedAt

  instrument Instrument @relation(fields: [instrument_name], references: [name], onDelete: Cascade)
  library    Library    @relation(fields: [library_id], references: [id], onDelete: Cascade)

  @@unique([instrument_name, library_id, variant])
}

model Privilege {
  id         String   @id @default(uuid())
  name       String   @unique
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  RolePrivilege RolePrivilege[]
}

model Profile {
  user_id         String  @id
  handle          String  @unique @default(uuid())
  given_name      String
  family_name     String?
  display_name    String?
  instrument_name String?
  bio             String?

  user       User        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  instrument Instrument? @relation(fields: [instrument_name], references: [name])

  @@index([given_name(sort: Asc), family_name(sort: Asc)])
}

model Role {
  // ID
  id String @id @default(uuid())

  // Required Attributes
  name String @unique

  // Optional Attributes
  description String?
  email       String? @unique

  // Metadata
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  // Relations
  RolePrivilege RolePrivilege[]
  UserRole      UserRole[]
}

model RolePrivilege {
  role_id      String
  privilege_id String

  role      Role      @relation(fields: [role_id], references: [id], onDelete: Cascade)
  privilege Privilege @relation(fields: [privilege_id], references: [id], onDelete: Cascade)

  @@id([role_id, privilege_id])
}

model User {
  id         String   @id @default(uuid())
  email      String   @unique
  password   String?
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  Profile              Profile?
  VerificationTokens   VerificationToken[]
  Attendances          Attendance[]
  UsuMembership        UsuMembership?
  MailingListRecipient MailingListRecipient?
  Payments             Payment[]
  UserRole             UserRole[]
}

model UserRole {
  user_id String
  role_id String

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role Role @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@id([user_id, role_id])
}

model UsuMembership {
  user_id    String   @id
  number     String   @unique @db.Char(7)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model VerificationToken {
  user_id    String
  token      String   @unique
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
}
